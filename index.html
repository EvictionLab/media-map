<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='utf-8' />
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Eviction Lab | Media Map</title>
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel="manifest" href="https://evictionlab.org/tool/assets/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="https://evictionlab.org/tool/assets/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://evictionlab.org/tool/assets/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://evictionlab.org/tool/assets/images/favicon-16x16.png">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.45.0/mapbox-gl.js'></script>
    <script src="https://unpkg.com/supercluster@3.0.2/dist/supercluster.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>
    <script type="text/javascript" src="https://pym.nprapps.org/pym.v1.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.45.0/mapbox-gl.css' rel='stylesheet' />
    <link href='https://d15y7nbot0snb4.cloudfront.net/fonts/641838/721A2AA74EF28AABC.css' rel='stylesheet' />
    <link href='https://evictionlab.org/css/lib.min.css' rel='stylesheet' />
    <link href='https://evictionlab.org/css/main-sass.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; min-height: 500px; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
        .mapboxgl-popup-content {
            max-width: 350px;
            max-height: 250px;
            overflow-y: scroll;
            margin-bottom: 0;
            padding: 24px;
        }
        .mapboxgl-popup-content p {
            font-family: Akkurat-Regular,sans-serif;
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 0;
            margin-bottom: 8px;
        }
        .mapboxgl-popup-content p:last-child {
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    <script>
        var SHEET_URL = 'https://spreadsheets.google.com/feeds/list/1fIHfkpG134ax5neHQGfipUrWbzPd-EAlVVlYqm4i9iE/1/public/values?alt=json'
        mapboxgl.accessToken = 'pk.eyJ1IjoiZXZpY3Rpb24tbGFiIiwiYSI6ImNqY20zamVpcTBwb3gzM28yb292YzM3dXoifQ.uKgAjsMd4qkJNqEtr3XyPQ';
        var map = new mapboxgl.Map({
            container: 'map',
            style: './style.json',
            center: [-103.59179687498357, 40.66995747013945],
            zoom: 3
        });
        var pymChild = new pym.Child();
        map.on('loaded', function() {
            pymChild.sendHeight();
        });

        map.on('mouseenter', 'clusters', function() {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'clusters', function() {
            map.getCanvas().style.cursor = '';
        });

        function createTooltip(coords, features) {
            var content = document.createElement('div');
            content.innerHTML = features.map(function (f) {
                return '<p>' + f.properties.outlet + ' | <a target="_blank" href="' +
                    f.properties.link + '">' + f.properties.title + '</a></p>';
            }).join('');
            new mapboxgl.Popup()
                .setLngLat(coords)
                .setDOMContent(content)
                .addTo(map);
            content.parentNode.className += ' modal-content modal-header';
            document.querySelector('.mapboxgl-popup-close-button').className += ' close';
        }

        function featuresOnClick(e) {
            if (e.features.length === 0) { return; }
            var coords = e.features[0].geometry.coordinates;
            if (!e.features[0].properties.hasOwnProperty('point_count')) {
                createTooltip(coords, e.features);
                return;
            }
            var r = 35;

            var bounds = map.getBounds();
            var bb = [bounds.getWest(), bounds.getSouth(), bounds.getEast(), bounds.getNorth()];
            var pt = map.project(coords);
            var sw = map.unproject({ x: pt.x - r, y: pt.y - r });
            var ne = map.unproject({ x: pt.x + r, y: pt.y + r });
            var bbox = [sw.lng, sw.lat, ne.lng, ne.lat];

            var index = supercluster({ radius: r, maxZoom: 14 });
            index.load(map.getSource('media').serialize().data.features);
            var clusterCount = e.features[0].properties.point_count;
            var clusters = index.getClusters(bb, Math.floor(map.getZoom()));
            var matchClusters = clusters.filter(function (c) {
                return (
                    c.properties.point_count === clusterCount &&
                    turf.booleanContains(turf.bboxPolygon(bbox), c)
                );
            });
            if (matchClusters.length === 1) {
                var clusterId = matchClusters[0].properties.cluster_id;
                var clusterFeatures = index.getLeaves(clusterId, 1000);
                createTooltip(coords, clusterFeatures);
            }
        }
        map.on('click', 'clusters', featuresOnClick);

        var req = new XMLHttpRequest();
        req.addEventListener("load", function () {
            var rows = JSON.parse(this.responseText).feed.entry;
            var properties = Object.keys(rows[0])
                .filter(function (p) { return p.startsWith("gsx$"); })
                .map(function (p) { return p.substr(4); });
            
            var items = rows.map(function (r) {
                var row = {};
                properties.forEach(function (p) {
                    row[p] = r["gsx$" + p].$t === "" ? null : r["gsx$" + p].$t;
                    if (['latitude', 'longitude'].indexOf(p) !== -1) {
                        row[p] = +row[p];
                    }
                    if (row[p] === null) {
                        row[p] = '';
                    }
                });
                return {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [row.longitude, row.latitude]
                    },
                    properties: row
                };
            });
            var mediaData = { type: 'FeatureCollection', features: items };
            map.getSource('media').setData(mediaData);
        });
        req.open("GET", SHEET_URL);
        req.send();
    </script>
</body>
</html>